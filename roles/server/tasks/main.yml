---
- name: Include OS specific variables
  ansible.builtin.include_vars: "{{ lookup('ansible.builtin.first_found', params) }}"
  vars:
    params:
      files:
        - 'os_{{ ansible_distribution }}.yml'
        - 'os_{{ ansible_os_family }}.yml'
      paths:
        - 'vars'

- name: Install Samba packages
  ansible.builtin.package:
    name: "{{ samba_packages }}"
    state: present
  when: samba_packages is defined and samba_packages | length > 0
  tags: samba

- name: Import fileserver
  ansible.builtin.import_tasks: fileserver.yml
  when:
    - samba_role == 'fileserver'

- name: Import dc_primary
  ansible.builtin.import_tasks: dc_primary.yml
  when:
    - samba_role == 'dc_primary'

- name: DC (primary or secondary)
  when:
    - samba_role == 'dc_primary' or samba_role == 'dc_secondary'
  block:
    - name: Import dc_configure
      ansible.builtin.import_tasks: dc_configure.yml
    - name: Import dc_krbtgt
      ansible.builtin.import_tasks: dc_krbtgt.yml

- name: Import Logs workaround
  ansible.builtin.import_tasks: logs-workaround.yml

- name: DC Admin password generated
  ansible.builtin.debug:
    var: samba_dc_admin_password
  when:
    - samba_role == 'dc_primary'
    - samba_dc_admin_password is not defined
    - smb_dc_result.rc is defined
    - smb_dc_result.rc != 0
